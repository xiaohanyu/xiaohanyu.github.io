<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="width=device-width, initial-scale=1, maximum-scale=2, user-scalable=no" name="viewport" />
    <meta content="行者无疆，始于足下——行走，思考，在路上" name="description" />
    <meta content="web development, programming, typeface, typography" name="keywords" />
    <meta content="Xiao Hanyu" name="author" />
    <link href="/apple-touch-icon-57x57.png" rel="apple-touch-icon" sizes="57x57" />
    <link href="/apple-touch-icon-60x60.png" rel="apple-touch-icon" sizes="60x60" />
    <link href="/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72" />
    <link href="/apple-touch-icon-76x76.png" rel="apple-touch-icon" sizes="76x76" />
    <link href="/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114" />
    <link href="/apple-touch-icon-120x120.png" rel="apple-touch-icon" sizes="120x120" />
    <link href="/apple-touch-icon-144x144.png" rel="apple-touch-icon" sizes="144x144" />
    <link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" />
    <link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" />
    <link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" />
    <link href="/favicon-194x194.png" rel="icon" sizes="194x194" type="image/png" />
    <link href="/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png" />
    <link href="/android-chrome-192x192.png" rel="icon" sizes="192x192" type="image/png" />
    <link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" />
    <link href="/manifest.json" rel="manifest" />
    <link color="#5bbad5" href="/safari-pinned-tab.svg" rel="mask-icon" />
    <meta content="#2d89ef" name="msapplication-TileColor" />
    <meta content="/mstile-144x144.png" name="msapplication-TileImage" />
    <meta content="#ffffff" name="theme-color" />
    <title>Build Static Site with Nanoc (II)</title>
    <link href="/static/dist/semantic-ui/semantic.min.css" rel="stylesheet" type="text/css" />
    <link href="/static/dist/fonts.css/fonts.css" rel="stylesheet" type="text/css" />
    <link href="/static/stylesheet/default.css" rel="stylesheet" type="text/css" />
    <link href="/static/stylesheet/pandoc-code-highlight.css" rel="stylesheet" type="text/css" />
    <script src="/static/dist/jquery/jquery.min.js"></script>
  </head>
  <body lang="cn">
    <div data-quotes-cn="[{&quot;content&quot;:[&quot;天上星，亮晶晶，永灿烂，长安宁。&quot;,&quot;湖边竹，盈盈绿，报平安，多喜乐。&quot;],&quot;author&quot;:&quot;金庸&quot;,&quot;from&quot;:&quot;天龙八部&quot;},{&quot;content&quot;:[&quot;死亡是唯一一座永远亮着的灯塔，不管你向哪里航行，最终都得转向它指引的方向。一切都会逝去，只有死神永生。&quot;],&quot;author&quot;:&quot;刘慈欣&quot;,&quot;from&quot;:&quot;地球往事&quot;},{&quot;content&quot;:[&quot;我终于明白了为什么 Einstein 喜爱看守灯塔的职业，因为那样他可以在自己的心灵中建立一片宁静而自由的天空。&quot;],&quot;author&quot;:&quot;卢昌海&quot;,&quot;from&quot;:&quot;&lt;a href=\&quot;http://www.changhai.org\&quot;&gt;http://www.changhai.org&lt;/a&gt;&quot;},{&quot;content&quot;:[&quot;我宁愿游荡在你身边&quot;,&quot;做七天的野鬼&quot;,&quot;跟随你&quot;,&quot;就算落进最黑暗的地方&quot;,&quot;我的爱&quot;,&quot;也不会让我成为永远的孤魂&quot;],&quot;author&quot;:&quot;李安&quot;,&quot;from&quot;:&quot;卧虎藏龙&quot;},{&quot;content&quot;:[&quot;在中国，任何超脱飞扬的思想都会砰然坠地——现实的引力实在是太沉重了。&quot;],&quot;author&quot;:&quot;刘慈欣&quot;,&quot;from&quot;:&quot;地球往事&quot;},{&quot;content&quot;:[&quot;天下唯庸人无咎无誉。&quot;],&quot;author&quot;:&quot;梁启超&quot;,&quot;from&quot;:&quot;李鸿章传&quot;},{&quot;content&quot;:[&quot;沧海横流，血肉横飞，方显出英雄本色，当年万源保卫战，敌军在不到 30 华里的地面上，使用兵力竞达九十个团，数量十倍于红军，谁能记清当时打了多少次恶仗？每天要牺牲多少人？他却是不多的幸存者之一。而眼前，一切都沉寂了，流逝了。那惊心动魄的枪声，那撕肝裂肺的呐喊，那悲痛欲绝的咒骂和呻吟，那狼藉遍野的残肢断骨和头颅，那千疮百孔仍迎风飘扬的军旗；都沉寂了，流逝了，无影无踪了，犹如做了一场梦……&quot;],&quot;author&quot;:&quot;都梁&quot;,&quot;from&quot;:&quot;亮剑&quot;}]" data-quotes-en="[{&quot;content&quot;:[&quot;Pascal is for building pyramids—imposing, breathtaking, static structures built by armies pushing heavy blocks into place. Lisp is for building organisms—imposing, breathtaking, dynamic structures built by squads fitting fluctuating myriads of simpler organisms into place.&quot;],&quot;author&quot;:&quot;Alan J. Perlis&quot;,&quot;from&quot;:&quot;foreword for &lt;a href=\&quot;http://mitpress.mit.edu/sicp/\&quot;&gt;SICP&lt;/a&gt;&quot;},{&quot;content&quot;:[&quot;When you don&#39;t create things, you become defined by your tastes rather than ability. Your tastes only narrow &amp; exclude people. So create.&quot;],&quot;author&quot;:&quot;why the luck stuff&quot;,&quot;from&quot;:&quot;&lt;a href=\&quot;http://whymirror.github.io/\&quot;&gt;http://whymirror.github.io/&lt;/a&gt;&quot;},{&quot;content&quot;:[&quot;In theory, there is no difference between theory and practice. But, in practice, there is.&quot;],&quot;author&quot;:&quot;Jan L. A. van de Snepscheut&quot;,&quot;from&quot;:&quot;&lt;a href=\&quot;http://en.wikiquote.org/wiki/Jan_L._A._van_de_Snepscheut\&quot;&gt;Wikipedia&lt;/a&gt;&quot;},{&quot;content&quot;:[&quot;The future has already arrived. It is just not evenly distributed yet.&quot;],&quot;author&quot;:&quot;William Gibson&quot;,&quot;from&quot;:&quot;&lt;a href=\&quot;https://en.wikiquote.org/wiki/William_Gibson\&quot;&gt;Wikiquote&lt;/a&gt;&quot;}]" id="quotes" style="display: none"></div>
    <div id="content">
      <nav class="ui borderless menu" lang="en">
        <div class="ui container">
          <a class="item" href="/"><img src="/static/image/gravatar-black.svg" /></a><a class="item" href="/archive">Archive</a><a class="item desktop-only" href="/categories">Categories</a><a class="item desktop-only" href="/tags">Tags</a><a class="item" href="/about">About</a>
          <div class="right menu">
            <div class="item desktop-only">
              <form action="https://www.google.com/search" class="ui form" method="get" target="_blank">
                <input name="q" type="hidden" value="site:xiaohanyu.me" />
                <div class="ui transparent left icon input">
                  <input name="q" placeholder="Search..." type="text" /><i class="search icon"></i>
                </div>
              </form>
            </div>
            <a class="item" href="https://github.com/xiaohanyu"><i class="github icon"></i></a><a class="item desktop-only" href="/atom.xml"><i class="feed icon"></i></a>
          </div>
        </div>
      </nav><div class="ui stackable container">
  <div class="ui very padded segment article">
    <article class="ui stackable divided grid"><header class="row article-head">
  <div class="column">
    <h1>
      Build Static Site with Nanoc (II)
    </h1>
    <hr />
  </div>
</header>
<div class="row article-body">
  <section class="twelve wide column"><p><a href="http://xiaohanyu.me/2014/05/04/build-static-site-with-nanoc-1/">上篇</a>主要讲了用 nanoc 来构建一个 static site 的基本原理，这一篇专注于这个 blog 本身的一些设计。</p>
<h2>Bootstrap</h2>
<p><a href="http://getbootstrap.com/">Bootstrap</a> 现在大概已经成为像我一样的半吊子前端写网站的标配了吧，简单，明了，快捷，简直是为我这种人量身定做的。最开始我也是想一切自己动手，奈何还是没有禁住 Bootstrap 各种漂亮主题及插件的诱惑，最终还是不能免俗，从了 Bootstrap。</p>
<p>其实类似于 Bootstrap 的前端框架还是有一些的，比如 <a href="http://foundation.zurb.com/">Foundation</a> 和 <a href="http://semantic-ui.com/">Semantic UI</a> 。Semantic UI 甚至在其官方主页上指出了 Bootstrap 命名规则的混乱。不过 Bootstrap 最大的优势在于它的普及(<del>烂大街</del>)，这种普及甚至使得 Bootstrap 成了一个平台。</p>
较好的 Bootstrap 主题和模板：
<ul>
<li><a href="http://startbootstrap.com/" class="uri">http://startbootstrap.com/</a></li>
<li><a href="https://wrapbootstrap.com/" class="uri">https://wrapbootstrap.com/</a> ，很多收费</li>
<li><a href="http://www.blacktie.co/" class="uri">http://www.blacktie.co/</a> ，似乎是由个人设计师设计维护的 Bootstrap 主题站，质量都很不错</li>
<li><a href="http://bootswatch.com/" class="uri">http://bootswatch.com/</a> ，免费的 CSS 主题文件，使用简单，替换原有 Bootstrap 的 CSS 文件即可。</li>
</ul>
<p>另外， <a href="http://bootsnipp.com/">Bootsnipp</a> 提供了非常全面的各种有用的基于 Bootstrap 的 code snippets 和设计元素。本 blog 的 timeline 类型的 Archives 页面就来源于此。</p>
<h2>JS/CSS compress</h2>
<p>JS/CSS compress/minify 应该是前端开发的基本常识了。nanoc 中提供了 <a href="http://nanoc.ws/docs/api/Nanoc/Filters/Rainpress.html">rainpress</a> 和 <a href="http://nanoc.ws/docs/api/Nanoc/Filters/UglifyJS.html">uglify_js</a> 两个 filter，分别用于 CSS 和 JS 文件的压缩。但实际中，我们往往会有多个 JS/CSS 文件，而我们希望能将其压缩成单个 JS/CSS 文件。这方面 nanoc 没有提供内置的解决方案。好在 Google 是万能的，完美的<a href="http://jakoblaegdsmand.com/blog/2012/12/minifying-js-and-css-in-nanoc/">解决方案</a>也是存在的，感谢 <a href="http://jakoblaegdsmand.com/">Jakob</a> 。</p>
<p>Jakob 的 blog 写得浅显易懂，其主要的优点是可以通过 <code>nanoc.yml</code> 中的 <code>debug</code> 选项来启停 JS/CSS 的压缩。具体的原理和代码我就不再这里重复了，看博文吧。</p>
<h2>nanoc-cachebuster</h2>
<p>我们已经解决了 JS/CSS 的压缩问题，还差一步，就可以形成 nanoc static site frontend 的完美解决方案，那就是我们离不开的 cache。这个 cache 主要是浏览器端的 cache。Cache 是个好东西，只是有时会给开发人员造成一些小麻烦。比如我们修改 JS/CSS 文件并且 push 到“线上”的时候，在一定时间段内浏览器并不会请求最新的 JS/CSS 文件，而是会使用已有的尚未过期的 cache 中的 JS/CSS 文件，这就使得我们没有办法实时地看到 JS/CSS 修改后的前端效果。解决方案就是在开发时绕过 cache，让浏览器每次都请求最新的 JS/CSS 文件。这有两种办法，一是在浏览器端，可以强制刷新或者直接禁用浏览器的 cache，但是这种方案的局限性在于，每种浏览器都有自己的设置方法，并且做为开发人员，你没有办法保证你的用户都禁用 cache；第二种办法就是在服务器端做一些手脚，这就是 <a href="http://webassets.readthedocs.org/en/latest/expiring.html">cache busting</a> 。</p>
<p>Cache busting 的原理是每次修改 JS/CSS 文件后，通过在 JS/CSS 的文件名上加入一个版本号或者类似的手段，来保证浏览器请求的都是最新的 JS/CSS 文件，这样就能确保 JS/CSS 的效果能够实时地起到作用。Nanoc 有一个 <a href="http://avdgaag.github.io/nanoc-cachebuster/">nanoc-cachebuster</a> ，其作者写了一篇详细的 <a href="http://arjanvandergaag.nl/blog/nanoc-cachebuster.html">post</a> 来阐述 nanoc-cachebuster 的实现原理，我就不再多言了。</p>
<h2>Font Selection</h2>
<p>就观感上来讲，除了基本的版面设计，字体选择是第二重要的因素。你至少要知道<a href="http://zh.wikipedia.org/wiki/%25E8%25A1%25AC%25E7%25BA%25BF%25E4%25BD%2593">衬线字体</a>和<a href="http://zh.wikipedia.org/wiki/%25E6%2597%25A0%25E8%25A1%25AC%25E7%25BA%25BF%25E4%25BD%2593">无衬线字体</a>的基本概念。而在 Web 上应用这些概念，你还需要了解一些有关以 <a href="http://en.wikipedia.org/wiki/Web_typography">web font</a> 的一些知识。关于这点我就不展开写了，任何一本不错的 CSS 书籍都会用一章的内容来详细讲解字体以及 web font 的概念。我个人的选择是 <a href="https://www.google.com/fonts/specimen/Lora">Lora</a> ，灵感来自于 <a href="http://bootswatch.com/readable/">bootswatch readable theme</a> 。</p>
<p>这里还有两个小技巧，和大家分享。一是在 CSS 中，字体的样式是依照 <code>font-family</code> 的值以及相应的字体本身的特性决定的。比如：</p>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css">body <span class="kw">{</span>
  <span class="kw">background-color:</span> <span class="dt">#ffffff</span><span class="kw">;</span>
  <span class="kw">font-family:</span> <span class="st">&#39;Lora&#39;</span>, Georgia, <span class="st">&#39;Times New Roman&#39;</span>, <span class="st">&#39;SimSun&#39;</span>, <span class="st">&#39;Microsoft YaHei&#39;</span>, <span class="dt">serif</span><span class="kw">;</span>
<span class="kw">}</span></code></pre></div>
<p>这里指定 <code>&lt;body&gt;</code> 的字体为 Lora，但是 Lora 本身是一款英文字体，对于汉字是“无能为力”的，因此如果 <code>&lt;body&gt;</code> 中有汉字的话，浏览器会按照 <code>font-family</code> 所指定的值依次找下去，直到找到一款从 web 上加载的或者系统中已经存在的汉字字体。另外，在 Chrome 和 Firefox 的 Developer Tools 中可以看到浏览器渲染页面时所使用的字体的细节，具体参考 <a href="http://stackoverflow.com/questions/884177/how-can-i-determine-what-font-a-browser-is-actually-using-to-render-some-text">StackOverflow</a>。</p>
<h2>Third-party Plugins</h2>
<p>由于静态站点本身并没有数据库之类的标配的本地存储，因此像评论、站内搜索，以及统计这类功能需要借助第三方的服务。站内搜索比较简单，直接调用 Google 的 <code>site:xiaohanyu.me</code> 搜索即可：</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;form</span><span class="ot"> class=</span><span class="st">&quot;form-inline&quot;</span><span class="ot"> target=</span><span class="st">&quot;_blank&quot;</span><span class="ot"> method=</span><span class="st">&quot;get&quot;</span><span class="ot"> action=</span><span class="st">&quot;http://google.com/search&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> value=</span><span class="st">&quot;site:xiaohanyu.me&quot;</span><span class="ot"> name=</span><span class="st">&quot;q&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> class=</span><span class="st">&quot;form-control pull-left&quot;</span><span class="ot"> placeholder=</span><span class="st">&quot;Search&quot;</span><span class="ot"> name=</span><span class="st">&quot;q&quot;</span><span class="kw">&gt;</span>
<span class="kw">&lt;/form&gt;</span></code></pre></div>
<p>至于评论系统，我用的也就是现今最流行的第三方评论系统 <a href="https://disqus.com/">Disqus</a> 了。其安装设置非常简单，不再赘述。使用体验也不错。但是由于国内网络的原因，Disqus 加载的时候还是需要 2-4 秒的时间，因此我写了个 JS 函数，来按需加载 Disqus 评论。与此同时，我还在每篇 post 的 metadata 里面设置了新的属性： <code>disable_disqus</code> ，这样如果 <code>disable_disqus</code> 为真，那么相应的 post 就是禁用评论的。</p>
<p>最后就是站点统计，最简单的就是传统 Blog 上的网站访问计数。这个我用的是 <a href="http://www.google.com/analytics/">Google Analytics</a> ，很强大，安装配置也很简单，同样不再赘述。</p>
<h2>Atom/Sitemap/Robots.txt</h2>
<p>除了以上，一个有节操有品味的网站还应该配备 atom/sitemap/robots.txt。在 nanoc 中，这三种的解决方案是差不多的。以 atom 为例，nanoc3 内置的 <a href="http://nanoc.ws/docs/api/Nanoc/Helpers/Blogging.html">Blogging</a> 辅助模块提供了基本的 atom 生成函数 <a href="http://nanoc.ws/docs/api/Nanoc/Helpers/Blogging.html#atom_feed-instance_method">atom_feed</a> ，我们需要做的就是动态创建一个 nanoc item，而这个 item 的任务就是生成实际的 <code>atom.xml</code> 文件。nanoc 支持 <a href="http://nanoc.ws/docs/basics/">preprocess</a> ，我们可以在 nanoc compile 之前做一些准备工作：</p>
<ul>
<li><code>Rules</code></li>
</ul>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby">preprocess <span class="kw">do</span>
  create_github_cname
  create_robots_txt
  create_sitemap
  create_atom
<span class="kw">end</span>

compile <span class="ot">%r{/sitemap/|/atom/|/robots/}</span> <span class="kw">do</span>
  filter <span class="st">:erb</span>
<span class="kw">end</span>

route <span class="ot">%r{/sitemap/|/atom/}</span> <span class="kw">do</span>
  item.identifier.chop + <span class="st">&#39;.xml&#39;</span>
<span class="kw">end</span></code></pre></div>
<p>在 <code>create_atom</code> 函数中，我们动态创建一个 <a href="http://nanoc.ws/docs/api/Nanoc/Item.html">nanoc item</a> （所谓动态创建的 item 就是这个 item 在实际的文件系统中没有相对应的文件）。这样的 preprocess 之后，nanoc compile 会按照指定的规则来处理生成 atom 的 item，最终生成所需的 <code>atom.xml</code> 。</p>
<ul>
<li><code>lib/preprocessors.rb</code></li>
</ul>
<div class="sourceCode"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span class="kw">def</span> create_atom
  content = &lt;&lt;<span class="kw">EOS</span>
<span class="ot">&lt;%= atom_feed \</span>
<span class="ot">:title =&gt; &#39;#{@site</span>.config[<span class="st">:meta_data</span>][<span class="st">:title</span>]<span class="ot">}&#39;,</span>
<span class="ot">:author_name =&gt; &#39;#{@site</span>.config[<span class="st">:meta_data</span>][<span class="st">:author</span>]<span class="ot">}&#39;,</span>
<span class="ot">:author_uri =&gt; &#39;#{@site</span>.config[<span class="st">:base_url</span>]<span class="ot">}&#39;,</span>
<span class="ot">:limit =&gt; 10 %&gt;</span>
<span class="ot">EOS</span>

<span class="ot">  @items &lt;&lt; Nanoc3::Item.new(content,</span>
<span class="ot">                             {:extension =&gt; &#39;xml&#39;, :is_hidden =&gt; true},</span>
<span class="ot">                             &#39;/atom/&#39;)</span>
<span class="ot">end</span>
</code></pre></div>
<h2>Cute Things</h2>
<p>除此之外，我还设计了一些有趣的小东西，当然，如果您是资深的前端工程师，那么可以直接忽略这一节，我怕班门弄斧，贻笑大方。</p>
<p>一是我给每篇 post 加上了 next 和 previous 的 link button， <del>当然如果有一天我的文章写的足够好能让人流连忘返的话</del> ，这两个 button 或许是有用的。具体的技术细节可以参考<a href="https://ecarmi.org/writing/next-previous-links-nanoc/">这里</a>。</p>
<p>二是我在页面上加了一个 <strong>back-to-top</strong> 的 button，这样在页面滚了一点进度时，back-to-top button 会出现在右下角，然后你可以点击这个 button 回到页面的最顶端。</p>
<p>三是我参考一些成型的设计，给自己的 blog 设计了一个还算满意的 <a href="http://xiaohanyu.me/does-not-exist">404 page</a>。</p>
<p>最后，我在 <a href="http://wxiaohanyu.me/about/index.html">about page</a> 中加入了一些 random quotes 的小把戏，这样每次访问/刷新 about page 的时候，你看到的 quotes 都是随机的。至于原理，暂且不表 ^_^。</p>
<h2>总结</h2>
<p>以上，大概记录了我个人建站的基本过程，从基本的技术选型，到版式字体的设计，以及一些 nanoc 的小技巧，希望对您有用。</p>

    <hr />
    <div id="disqus_thread"></div>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </section>
  <aside class="four wide column" lang="en">
    <div class="ui small header">
      Committed
    </div>
    <date>2014-07-26</date>
    <div class="ui small header">
      Category
    </div>
    <div class="ui list">
      <div class="item">
        <a href="/categories#technology">
          <div class="ui label">
            Technology<sup>2</sup>
          </div>
        </a>
      </div>
    </div>
    <div class="ui small header">
      Tags
    </div>
    <div class="ui list">
      <div class="item">
        <a href="/tags#nanoc">
          <div class="ui label">
            Nanoc<sup>2</sup>
          </div>
        </a>
      </div>
      <div class="item">
        <a href="/tags#bootstrap">
          <div class="ui label">
            Bootstrap<sup>1</sup>
          </div>
        </a>
      </div>
    </div>
    <div class="ui small header">
      Links
    </div>
    <div class="ui small two item menu">
      <a class="item" title="Build Static Site with Nanoc (I)" href="/posts/2014-05-04-build-static-site-with-nanoc-1/">Prev</a><a class="item" title="2014，漫步" href="/posts/2015-04-10-2014-summary/">Next</a>
    </div>
  </aside>
</div>
    </article>
  </div>
</div>
    </div>
    <div id="footer">
      <footer class="ui center aligned container" lang="en">
        <hr />
        <p>
          Copyright © 2014–2016 by Xiao Hanyu. All Rights Reserved.
        </p>
      </footer>
      <script src="/static/dist/semantic-ui/semantic.min.js"></script>
      <script src="/static/javascript/ga.js"></script>
      <script src="/static/javascript/default.js"></script>
      <script src="/static/javascript/disqus.js"></script>
    </div>
  </body>
</html>